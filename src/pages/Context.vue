<template>
	<div class="row">
		<div v-if="loading" class="icon-loading" />
		<div v-if="!loading && context">
			<div class="content first-row">
				<div class="row">
					<h1> {{ context.iconName }}&nbsp; {{ context.name }}</h1>
				</div>
				<div class="row">
					<h3> {{ context.description }}</h3>
				</div>
			</div>

			<div class="resources">
				<div v-for="resource in contextResources" :key="resource.key">
					<div v-if="!resource.isView">
						<TableWrapper :table="resource" :columns="columns[resource.key]" :rows="rows[resource.key]"
							:view-setting="viewSetting" @create-column="createColumn(false, resource)"
							@import="openImportModal(resource, false)" @download-csv="downloadCSV(resource, false)" />
					</div>
					<div v-else-if="resource.isView">
						<CustomView :view="resource" :columns="columns[resource.key]" :rows="rows[resource.key]"
							:view-setting="viewSetting" @create-column="createColumn(true, resource)"
							@import="openImportModal(resource, true)" @download-csv="downloadCSV(resource, true)" />
					</div>
				</div>
			</div>

			<MainModals />
		</div>
	</div>
</template>

<script>
import MainModals from '../modules/modals/Modals.vue'
import Vuex, { mapState } from 'vuex'
import Vue from 'vue'
import TableWrapper from '../modules/main/sections/TableWrapper.vue'
import CustomView from '../modules/main/sections/View.vue'
import { emit } from '@nextcloud/event-bus'

Vue.use(Vuex)

export default {
	components: {
		MainModals,
		TableWrapper,
		CustomView,
	},

	data() {
		return {
			loading: true,
			viewSetting: {},
			context: null,
			contextResources: [],
		}
	},

	computed: {
		...mapState(['tables', 'contexts', 'activeContextId', 'views']),
		rows() {
			const rows = {}
			if (this.context && this.context.nodes) {
				for (const [, node] of Object.entries(this.context.nodes)) {
					if (node.node_type === '0') {
						const rowId = (node.node_id).toString()
						rows[rowId] = this.$store.state.data.rows[rowId]

					} else if (node.node_type === '1') {
						const rowId = 'view-' + (node.node_id).toString()
						rows[rowId] = this.$store.state.data.rows[rowId]
					}
				}
			}
			return rows

		},

		columns() {
			const columns = {}
			if (this.context && this.context.nodes) {
				for (const [, node] of Object.entries(this.context.nodes)) {
					if (node.node_type === '0') {
						const columnId = (node.node_id).toString()
						columns[columnId] = this.$store.state.data.columns[columnId]
					} else if (node.node_type === '1') {
						const columnId = 'view-' + (node.node_id).toString()
						columns[columnId] = this.$store.state.data.columns[columnId]

					}

				}
			}
			return columns
		}
	},

	watch: {
		async activeContextId() {
			await this.reload()
		},
	},

	async mounted() {
		await this.reload()
	},

	methods: {
		async reload() {
			this.loading = true
			if (this.activeContextId) {
				await this.loadContext()
			}
			this.loading = false
		},
		async loadContext() {
			console.log('id', this.activeContextId)
			this.contextResources = []
			await this.$store.dispatch('getContext', { id: this.activeContextId })
			const index = this.contexts.findIndex(c => parseInt(c.id) === parseInt(this.activeContextId))
			this.context = this.contexts[index]

			console.log('loaded context', this.context)

			if (this.context && this.context.nodes) {
				for (const [, node] of Object.entries(this.context.nodes)) {
					// table
					if (node.node_type === '0') {
						const table = this.tables.find(table => table.id === node.node_id)
						await this.$store.dispatch('loadColumnsFromBE', {
							view: null,
							tableId: table.id,
						})
						await this.$store.dispatch('loadRowsFromBE', {
							viewId: null,
							tableId: table.id,
						})
						table['key'] = (table.id).toString()
						table['isView'] = false
						this.contextResources.push(table)
					}
					else if (node.node_type === '1') {
						const view = this.views.find(view => view.id === node.node_id)
						await this.$store.dispatch('loadColumnsFromBE', {
							view: view,
							tableId: view.tableId,
						})
						await this.$store.dispatch('loadRowsFromBE', {
							viewId: view.id,
							tableId: view.tableId,
						})
						view['key'] = 'view-' + (view.id).toString()
						view['isView'] = true
						this.contextResources.push(view)
					}
				}
			}
		},
		createColumn(isView, element) {
			emit('tables:column:create', { isView, element })
		},
		downloadCSV(element, isView) {
			const rowId = !isView ? 'rows' + element.id : 'view-rows' + element.id
			const colId = !isView ? 'columns' + element.id : 'view-columns' + element.id
			this.downloadCsv(this.tableData[rowId], this.tableData[colId], element.title)
		},
		openImportModal(element, isView) {
			emit('tables:modal:import', { element, isView })
		},
	},
}

</script>

<style scoped lang="scss">
.content {
	margin: 50px;
}
.resource, content {
	padding: 30px 0;
}
</style>
