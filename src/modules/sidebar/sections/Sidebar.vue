<template>
	<div>
		<NcAppSidebar v-show="showSidebar"
			:active="activeSidebarTab"
			:title="elementTitle"
			:subtitle="elementSubtitle"
			@update:active="tab => activeSidebarTab = tab"
			@close="showSidebar = false">
			<NcAppSidebarTab v-if="canShareActiveTable"
				id="sharing"
				icon="icon-share"
				:name="t('tables', 'Sharing')">
				<SidebarSharing />
			</NcAppSidebarTab>
			<NcAppSidebarTab
				id="integration"
				icon="icon-share"
				:name="t('tables', 'Integration')">
				<SidebarIntegration />
				<template #icon>
					<Creation :size="20" />
				</template>
			</NcAppSidebarTab>
		</NcAppSidebar>
	</div>
</template>
<script>
import { subscribe, unsubscribe } from '@nextcloud/event-bus'
import SidebarSharing from './SidebarSharing.vue'
import SidebarIntegration from './SidebarIntegration.vue'
import { NcAppSidebar, NcAppSidebarTab } from '@nextcloud/vue'
import { mapGetters, mapState } from 'vuex'
import Creation from 'vue-material-design-icons/Creation.vue'
import tablePermissions from '../../main/mixins/tablePermissions.js'

export default {
	name: 'Sidebar',
	components: {
		SidebarSharing,
		SidebarIntegration,
		NcAppSidebar,
		NcAppSidebarTab,
		Creation,
	},

	mixins: [tablePermissions],

	data() {
		return {
			showSidebar: false,
			activeSidebarTab: '',
		}
	},
	computed: {
		...mapState(['tables']),
		...mapGetters(['activeTable', 'activeView']),
		elementTitle() {
			if (this.activeTable) {
				return this.activeTable.emoji + ' ' + this.activeTable.title
			} else if (this.activeView) {
				return this.activeView.emoji + ' ' + this.activeView.title
			} else {
				return t('tables', 'No table in context')
			}
		},
		elementSubtitle() {
			if (this.activeTable) {
				return t('tables', 'From {ownerName}', { ownerName: this.activeTable.ownership })
			} else if (this.activeView) {
				return t('tables', 'From {ownerName}', { ownerName: this.activeView.createdBy })
				// TODO: Created By?
			} else {
				return ''
			}
		},
	},
	mounted() {
		subscribe('tables:sidebar:sharing', data => this.handleToggleSidebar(data))
		subscribe('tables:sidebar:integration', data => this.handleToggleSidebar(data))
	},
	beforeDestroy() {
		unsubscribe('tables:sidebar:sharing', data => this.handleToggleSidebar(data))
		unsubscribe('tables:sidebar:integration', data => this.handleToggleSidebar(data))
	},
	methods: {
		handleToggleSidebar(data) {
			console.debug('toggle sidebar in nav', data)
			this.showSidebar = data.open ? data.open : false
			this.activeSidebarTab = data.tab ? data.tab : ''
		},
	},
}
</script>
